

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Evaluate a Pre-Trained Segmentation Model in Colab on 2019 data &mdash; Mussel-Image-Analysis v1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Mussel-Image-Analysis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/quadrat.html">Quadrat Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/predict.html">Predict</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/labelme.html">Dataset Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/reproduce-dataset.html">Reproduce Datasets</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mussel-Image-Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Evaluate a Pre-Trained Segmentation Model in Colab on 2019 data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/predict/task_3_evaluate_test_predictions.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Evaluate-a-Pre-Trained-Segmentation-Model-in-Colab-on-2019-data">
<h1>Evaluate a Pre-Trained Segmentation Model in Colab on 2019 data<a class="headerlink" href="#Evaluate-a-Pre-Trained-Segmentation-Model-in-Colab-on-2019-data" title="Permalink to this headline">¶</a></h1>
<p>This notebook is for generating predictions on the GLNI 2019 test set and evaluating the proportion of variance (<span class="math notranslate nohighlight">\(R^2\)</span>) in live coverage, biomass, and count, explained by the predictions.</p>
<p>Since I do not have access to the lab analysis tables for the 2019 data, it currently performs the analysis on the training images as a demonstration, but in line comments are provided in order to make the transition to the 2019 data.</p>
<p>This notebook is designed to be as lean as possible, it <strong>does not</strong> aim to provide interactive visualizations, for this see other notebooks, for example: <code class="docutils literal notranslate"><span class="pre">task_3_evaluate_notebook_in_colab</span></code></p>
<p><strong>Note:</strong> To maintain a high priority Colab user status such that sufficient GPU resources are available in the future, ensure to free the runtime when finished running this notebook. This can be done using ‘Runtime &gt; Manage Sessions’ and click ‘Terminate’.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Check if notebook is running in Colab or local workstation</span>
<span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">!</span>ln -sf /opt/bin/nvidia-smi /usr/bin/nvidia-smi
    <span class="o">!</span>pip install gputil
    <span class="o">!</span>pip install psutil
    <span class="o">!</span>pip install humanize

<span class="kn">import</span> <span class="nn">GPUtil</span> <span class="k">as</span> <span class="nn">GPU</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">humanize</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">GPUs</span> <span class="o">=</span> <span class="n">GPU</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># XXX: only one GPU on Colab and isn’t guaranteed</span>
    <span class="n">gpu</span> <span class="o">=</span> <span class="n">GPUs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">printm</span><span class="p">():</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gen RAM Free: &quot;</span> <span class="o">+</span> <span class="n">humanize</span><span class="o">.</span><span class="n">naturalsize</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span><span class="p">),</span>
              <span class="s2">&quot; | Proc size: &quot;</span> <span class="o">+</span> <span class="n">humanize</span><span class="o">.</span><span class="n">naturalsize</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU RAM Free: </span><span class="si">{0:.0f}</span><span class="s2">MB | Used: </span><span class="si">{1:.0f}</span><span class="s2">MB | Util </span><span class="si">{2:3.0f}</span><span class="s2">% | Total </span><span class="si">{3:.0f}</span><span class="s2">MB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">gpu</span><span class="o">.</span><span class="n">memoryFree</span><span class="p">,</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryUsed</span><span class="p">,</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryUtil</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryTotal</span><span class="p">))</span>
    <span class="n">printm</span><span class="p">()</span>

    <span class="c1"># Check if GPU capacity is sufficient to proceed</span>
    <span class="k">if</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryFree</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Insufficient memory! Some cells may fail. Please try restarting the runtime using &#39;Runtime → Restart Runtime...&#39; from the menu bar. If that doesn&#39;t work, terminate this session and try again later.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">GPU memory is sufficient to proceeed.&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select the Runtime → &quot;Change runtime type&quot; menu to enable a GPU accelerator, &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;and then re-execute this cell.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
    <span class="n">DATA_PATH</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;/content/drive/My Drive/Data&#39;</span>

    <span class="c1"># cd into git repo so python can find utils</span>
    <span class="o">%</span><span class="k">cd</span> &#39;/content/drive/My Drive/cciw-zebra-mussel/predict&#39;

    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/content/drive/My Drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>

<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># for manually reading high resolution images</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># for comparing predictions to lab analysis data frames</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># for plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># pytorch core library</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># pytorch neural network functions</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span>  <span class="c1"># notebook friendly progress bar</span>

<span class="c1"># evaluation metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>

<span class="kn">from</span> <span class="nn">task_3_utils</span> <span class="kn">import</span> <span class="n">img_to_nchw_tensor</span><span class="p">,</span> <span class="n">pretty_image</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Confim that this cell prints &quot;Found GPU, cuda&quot;. If not, select &quot;GPU&quot; as</span>
<span class="sd">&quot;Hardware Accelerator&quot; under the &quot;Runtime&quot; tab of the main menu.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found GPU,&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="1.-Load-a-pre-trained-model-checkpoint">
<h2>1. Load a pre-trained model checkpoint<a class="headerlink" href="#1.-Load-a-pre-trained-model-checkpoint" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;Checkpoints/deeplabv3_resnet50_lr1e-01_wd5e-04_bs40_ep80_seed1&#39;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATA_PATH&#39;</span><span class="p">],</span> <span class="s1">&#39;cciw/logs/cmp-dataset/train_v120/deeplabv3_resnet50/lr1e-01/wd5e-04/bs40/ep80/seed1/checkpoint&#39;</span><span class="p">)</span>

<span class="n">ckpt_file</span> <span class="o">=</span> <span class="s1">&#39;deeplabv3_resnet50_lr1e-01_wd5e-04_bs40_ep80_seed1_epoch79.ckpt&#39;</span>

<span class="n">model_to_load</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ckpt_file</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading&#39;</span><span class="p">,</span> <span class="n">model_to_load</span><span class="p">)</span>

<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_to_load</span><span class="p">)</span>

<span class="n">train_loss</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;trn_loss&#39;</span><span class="p">]</span>
<span class="n">val_loss</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==&gt; Resuming from checkpoint..&#39;</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span>
<span class="n">last_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;rng_state&#39;</span><span class="p">])</span>

<span class="c1"># later appended to figure filenames</span>
<span class="n">model_stem</span> <span class="o">=</span> <span class="n">ckpt_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded model </span><span class="si">%s</span><span class="s1"> trained to epoch &#39;</span> <span class="o">%</span> <span class="n">model_stem</span><span class="p">,</span> <span class="n">last_epoch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s1">&#39;Cross-entropy loss </span><span class="si">{:.4f}</span><span class="s1"> for train set, </span><span class="si">{:.4f}</span><span class="s1"> for validation set&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_loss</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">))</span>

<span class="n">sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># initializes a sigmoid function</span>

<span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="2.-Set-path-to-original,-i.e.,-full-size-images">
<h2>2. Set path to original, i.e., full size images<a class="headerlink" href="#2.-Set-path-to-original,-i.e.,-full-size-images" title="Permalink to this headline">¶</a></h2>
<p>Here we manually load and preprocess the original images and png masks using OpenCV.</p>
<div class="section" id="Note-to-Dominique:-set-root_path-to-point-to-validation-images-after-enabling-2019-tables">
<h3>Note to Dominique: set <code class="docutils literal notranslate"><span class="pre">root_path</span></code> to point to validation images after enabling 2019 tables<a class="headerlink" href="#Note-to-Dominique:-set-root_path-to-point-to-validation-images-after-enabling-2019-tables" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>

    <span class="c1"># uncomment me after enabling 2019 table!</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;ADIG_Labelled_Dataset/val_v101/GLNI&#39;</span><span class="p">)</span>
    <span class="c1">#root_path = osp.join(DATA_PATH, &#39;ADIG_Labelled_Dataset/train_v120/&#39;)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1">#root_path = &#39;/scratch/ssd/gallowaa/cciw/VOCdevkit/Validation-v101-originals/&#39;</span>
    <span class="c1">#root_path = &#39;/scratch/ssd/gallowaa/cciw/VOCdevkit/Train-v112-originals/&#39;</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="s1">&#39;/scratch/ssd/gallowaa/cciw/dataset_raw/Test/GLNI/all-unlabelled/&#39;</span>

<span class="c1">#jpeg_files = glob.glob(osp.join(root_path, &#39;JPEGImages/&#39;) + &#39;*.jpg&#39;)</span>
<span class="c1">#png_files = glob.glob(osp.join(root_path, &#39;SegmentationClass/&#39;) + &#39;*_crop.png&#39;)</span>

<span class="n">jpeg_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">&#39;*.jpg&#39;</span><span class="p">)</span>
<span class="n">png_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">&#39;*_crop.png&#39;</span><span class="p">)</span>

<span class="n">jpeg_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">png_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Should equal 121 for train-v112</span>
<span class="sd">Should equal 152 for train-v120</span>
<span class="sd">Should equal  55 for val-v101</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">png_files</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">left</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># the left side of the subplots of the figure</span>
<span class="n">right</span> <span class="o">=</span> <span class="mf">0.98</span>  <span class="c1"># the right side of the subplots of the figure</span>
<span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># the bottom of the subplots of the figure</span>
<span class="n">top</span> <span class="o">=</span> <span class="mf">0.95</span>  <span class="c1"># the top of the subplots of the figure</span>
<span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># the amount of width reserved for space between subplots, expressed as a fraction of the average axis width</span>
<span class="n">hspace</span> <span class="o">=</span> <span class="mf">0.1</span>   <span class="c1"># the amount of height reserved for space between subplots, expressed as a fraction of the average axis height</span>

<span class="n">BIOMASS_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">COUNT_IDX</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">LIVE_COV_IDX</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="3.-Populate-dataframe-of-lab-measurements-associated-with-jpeg_files">
<h2>3. Populate dataframe of lab measurements associated with <code class="docutils literal notranslate"><span class="pre">jpeg_files</span></code><a class="headerlink" href="#3.-Populate-dataframe-of-lab-measurements-associated-with-jpeg_files" title="Permalink to this headline">¶</a></h2>
<p>Here we predict the mussel biomass from the lab analysis using a) the masks, and b) model predictions on the full size images.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>

    <span class="c1"># set DATA_PATH local machine</span>
    <span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATA_PATH&#39;</span><span class="p">],</span> <span class="s1">&#39;cciw/Data&#39;</span><span class="p">)</span>

    <span class="c1"># enable LaTeX style fonts only on local workstation</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>

    <span class="c1"># local plotting functions</span>
    <span class="kn">from</span> <span class="nn">plot_utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># these functions are defined in plot_utils</span>
    <span class="c1"># but that package uses latex fonts which are incompatible with Colab</span>
    <span class="k">def</span> <span class="nf">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">linear_regression</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
        <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
        <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">res</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x_</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x_</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x_</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the validation set has version code 101</span>
<span class="n">imagetable_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;Tables&#39;</span><span class="p">,</span> <span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageTable2019.csv&#39;</span><span class="p">)</span>
<span class="n">analysis_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;Tables&#39;</span><span class="p">,</span> <span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;Analysis2019.csv&#39;</span><span class="p">)</span>
<span class="n">dive_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;Tables&#39;</span><span class="p">,</span> <span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;Dives2019.csv&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">imagetable_path = osp.join(DATA_PATH, &#39;Tables&#39;, &#39;ImageTable.csv&#39;)</span>
<span class="sd">analysis_path = osp.join(DATA_PATH, &#39;Tables&#39;, &#39;Analysis.csv&#39;)</span>
<span class="sd">dive_path = osp.join(DATA_PATH, &#39;Tables&#39;, &#39;Dives.csv&#39;)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">image_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">imagetable_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">analysis_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
<span class="n">dive_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dive_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">analysis_df</span><span class="p">,</span> <span class="n">dive_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Dive Index&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#image_df</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#data_df.loc[data_df[&#39;Live Coverage&#39;].notnull()]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="3.-a)-Do-predictions-for-all-images">
<h1>3. a) Do predictions for all images<a class="headerlink" href="#3.-a)-Do-predictions-for-all-images" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prd_ct</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for storing the number of mussel pixels in each prediction</span>

<span class="c1"># This cell takes some time because we&#39;re randomly reading large images from Google Drive</span>
<span class="c1"># This loop runs at 1.5 seconds per image on my workstation.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">)),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; image&#39;</span><span class="p">):</span>

    <span class="n">bgr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">jpeg_files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="c1"># pre-processing image consistent with PyTorch training transforms</span>
    <span class="n">nchw_tensor</span> <span class="o">=</span> <span class="n">img_to_nchw_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># saves memory in forward pass if no gradients required</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">sig</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">nchw_tensor</span><span class="p">)[</span><span class="s1">&#39;out&#39;</span><span class="p">])</span>

    <span class="n">prd_ct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

<span class="n">prd_ct_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">prd_ct</span><span class="p">)</span>
<span class="n">x_pred</span> <span class="o">=</span> <span class="n">prd_ct_np</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Normalize inputs between 0 and 1</span>
<span class="n">x_pred</span> <span class="o">=</span> <span class="n">x_pred</span> <span class="o">/</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Denote segmentation masks <code class="docutils literal notranslate"><span class="pre">x_seg_label</span></code> and predictions <code class="docutils literal notranslate"><span class="pre">x_pred</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># 0 = biomass, 1 = count, 2 = live coverage</span>
<span class="n">lab_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">)):</span>

    <span class="c1"># get unique identifier from jpeg filename which acts as a key into dataframe</span>
    <span class="n">root_fname</span> <span class="o">=</span> <span class="n">jpeg_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
        <span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_image&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;GLNI_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get a globally unique ID corresponding to image</span>
    <span class="c1"># get a globally unique ID corresponding to image</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">guid</span> <span class="o">=</span> <span class="n">image_df</span><span class="p">[</span><span class="n">image_df</span><span class="p">[</span><span class="s1">&#39;Image Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="n">root_fname</span><span class="p">)][</span><span class="s1">&#39;Analysis Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>

        <span class="c1"># extract relevant row from data frame</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Analysis Index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">guid</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>

        <span class="c1"># extract Biomass, Count, and Live Coverage from row</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">BIOMASS_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Biomass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">COUNT_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">LIVE_COV_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Live Coverage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">BIOMASS_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">COUNT_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lab_targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">LIVE_COV_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="n">valid_biomass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">BIOMASS_IDX</span><span class="p">]))</span>
<span class="n">valid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">COUNT_IDX</span><span class="p">]))</span>
<span class="n">valid_live_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">LIVE_COV_IDX</span><span class="p">]))</span>

<span class="n">biomass</span> <span class="o">=</span> <span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">BIOMASS_IDX</span><span class="p">][</span><span class="n">valid_biomass</span><span class="p">]</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">COUNT_IDX</span><span class="p">][</span><span class="n">valid_count</span><span class="p">]</span>
<span class="n">live_cov</span> <span class="o">=</span> <span class="n">lab_targets</span><span class="p">[:,</span> <span class="n">LIVE_COV_IDX</span><span class="p">][</span><span class="n">valid_live_cov</span><span class="p">]</span>

<span class="c1"># Normalize targets between 0 and 1</span>
<span class="n">biomass</span> <span class="o">=</span> <span class="n">biomass</span> <span class="o">/</span> <span class="n">biomass</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">count</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">live_cov</span> <span class="o">=</span> <span class="n">live_cov</span> <span class="o">/</span> <span class="n">live_cov</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got </span><span class="si">%d</span><span class="s1"> valid biomass measurements&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomass</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got </span><span class="si">%d</span><span class="s1"> valid count measurements&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got </span><span class="si">%d</span><span class="s1"> valid live coverage measurements&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">live_cov</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Predict-Live-Coverage,-Biomass,-and-Count">
<h1>Predict Live Coverage, Biomass, and Count<a class="headerlink" href="#Predict-Live-Coverage,-Biomass,-and-Count" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">title_stem</span> <span class="o">=</span> <span class="s1">&#39;$\mathbf{R^2}$ = &#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># no latex for Colab</span>
    <span class="n">title_stem</span> <span class="o">=</span> <span class="s1">&#39;R2 = &#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">## live coverage ##</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
              <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Live Coverage&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">live_cov</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)</span>

<span class="c1">## biomass ##</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
              <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Biomass&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Prediction&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">biomass</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span>
    <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)</span>

<span class="c1">## count ##</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">draw_sublabel</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;\textbf{a)}&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
    <span class="n">draw_sublabel</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;\textbf{b)}&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
    <span class="n">draw_sublabel</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;\textbf{c)}&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>

<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>
<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>
<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># uncomment to save figure</span>
<span class="c1">#fname = &#39;val_v101_livecov_biomass_and_count_from_predictions_abc&#39;</span>
<span class="c1">#fig.savefig(fname + &#39;.png&#39;)</span>
<span class="c1">#fig.savefig(fname + &#39;.eps&#39;, format=&#39;eps&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">r2_score</span><span class="p">(</span><span class="n">countin</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">][</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">],</span> <span class="n">countin</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countin</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">len</span><span class="p">(</span><span class="n">countin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Continue-to-compare-the-model-against-the-segmentation-masks">
<h1>Continue to compare the model against the segmentation masks<a class="headerlink" href="#Continue-to-compare-the-model-against-the-segmentation-masks" title="Permalink to this headline">¶</a></h1>
<p>The following cells <strong>will not</strong> run if using the 44 JPEG images from <code class="docutils literal notranslate"><span class="pre">Unlabeled_GLNI_OOD_Resolution</span></code> as they are unlabelled.</p>
</div>
<div class="section" id="3.-b)-Load-masks-for-all-images">
<h1>3. b) Load masks for all images<a class="headerlink" href="#3.-b)-Load-masks-for-all-images" title="Permalink to this headline">¶</a></h1>
<p>This will be used as a baseline when predicting live coverage, count, biomass.</p>
<p>The following cell <strong>will not</strong> run if using the 44 JPEG images from <code class="docutils literal notranslate"><span class="pre">Unlabeled_GLNI_OOD_Resolution</span></code> as they are unlabelled.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lab_ct</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for storing the number of mussel pixels in each mask</span>

<span class="c1"># This loop should run faster as model is not used,</span>
<span class="c1"># it runs at 4.5 images per second on my workstation</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">png_files</span><span class="p">)),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; image&#39;</span><span class="p">):</span>

    <span class="n">bgr_lab</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">png_files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">cts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bgr_lab</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># check if mask contains both classes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lab_ct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">cts</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="c1"># or only one class (background)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lab_ct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">lab_ct_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lab_ct</span><span class="p">)</span>
<span class="n">x_seg_label</span> <span class="o">=</span> <span class="n">lab_ct_np</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Normalize inputs between 0 and 1</span>
<span class="n">x_seg_label</span> <span class="o">=</span> <span class="n">x_seg_label</span> <span class="o">/</span> <span class="n">x_seg_label</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="4.-Live-Coverage">
<h2>4. Live Coverage<a class="headerlink" href="#4.-Live-Coverage" title="Permalink to this headline">¶</a></h2>
<p>From segmentation masks <code class="docutils literal notranslate"><span class="pre">x_seg_label</span></code> and predictions <code class="docutils literal notranslate"><span class="pre">x_pred</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Live Coverage&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
    <span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Segmentation Mask&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Prediction&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">live_cov</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span>
    <span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">live_cov</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span>
    <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_live_cov</span><span class="p">],</span> <span class="n">live_cov</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>
<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="5.-Biomass">
<h2>5. Biomass<a class="headerlink" href="#5.-Biomass" title="Permalink to this headline">¶</a></h2>
<p>From segmentation masks <code class="docutils literal notranslate"><span class="pre">x_seg_label</span></code> and predictions <code class="docutils literal notranslate"><span class="pre">x_pred</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Biomass&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
    <span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Segmentation Mask&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Prediction&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">biomass</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span>
    <span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">biomass</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_biomass</span><span class="p">],</span> <span class="n">biomass</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>
<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="6.-Count">
<h2>6. Count<a class="headerlink" href="#6.-Count" title="Permalink to this headline">¶</a></h2>
<p>From segmentation masks <code class="docutils literal notranslate"><span class="pre">x_seg_label</span></code> and predictions <code class="docutils literal notranslate"><span class="pre">x_pred</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
    <span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Segmentation Mask&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Mussel Pixels </span><span class="se">\n</span><span class="s1"> in Prediction&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>
<span class="n">draw_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_seg_label</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_stem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">valid_count</span><span class="p">],</span> <span class="n">count</span><span class="p">)),</span>  <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>
<span class="n">pretty_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Optionally-evaluate-on-out-of-distribution-resolution-for-testing-robustness">
<h1>Optionally evaluate on out-of-distribution resolution for testing robustness<a class="headerlink" href="#Optionally-evaluate-on-out-of-distribution-resolution-for-testing-robustness" title="Permalink to this headline">¶</a></h1>
<p>These GLNI 2019 images are from a 3788x6738 pixel source instead of the 4924x7378 pixels used for training. They are unlabeled, but suitable for testing against lab analysis.</p>
<p>After running this cell go back to step 3. a), but do not 3. b).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;ADIG_Labelled_Dataset/val_v101/Unlabeled_GLNI_OOD_Resolution/&#39;</span><span class="p">)</span>
    <span class="n">jpeg_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">&#39;*.jpg&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="s1">&#39;/scratch/ssd/gallowaa/cciw/dataset_raw/Test/GLNI/Unlabeled_GLNI_OOD_Resolution/&#39;</span>
    <span class="n">jpeg_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">&#39;*.jpg&#39;</span><span class="p">)</span>

<span class="n">jpeg_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">))</span> <span class="c1"># should equal 44</span>
</pre></div>
</div>
</div>
<p>Predictions are saved into the same folder as the checkpoint.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_root</span> <span class="o">=</span> <span class="n">ckpt_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">prediction_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model_to_load</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">prediction_path</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
<span class="n">prediction_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prediction_path</span><span class="p">,</span> <span class="s1">&#39;predictions&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prediction_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">prediction_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating folder&#39;</span><span class="p">,</span> <span class="n">prediction_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Folder&#39;</span><span class="p">,</span> <span class="n">prediction_path</span><span class="p">,</span> <span class="s1">&#39;already exists&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jpeg_files</span><span class="p">)),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; image&#39;</span><span class="p">):</span>

    <span class="n">image_root</span> <span class="o">=</span> <span class="n">jpeg_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">bgr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">jpeg_files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="c1"># pre-processing image consistent with PyTorch training transforms</span>
    <span class="n">nchw_tensor</span> <span class="o">=</span> <span class="n">img_to_nchw_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># saves memory in forward pass if no gradients required</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">sig</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">nchw_tensor</span><span class="p">)[</span><span class="s1">&#39;out&#39;</span><span class="p">])</span>
    <span class="n">pred_np</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">bgr_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_np</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input and Preds&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">pretty_image</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prediction_path</span><span class="p">,</span> <span class="n">image_root</span> <span class="o">+</span>
                         <span class="s1">&#39;__&#39;</span> <span class="o">+</span> <span class="n">model_root</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Angus Galloway

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>